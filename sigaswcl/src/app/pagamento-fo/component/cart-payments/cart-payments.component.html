<div class="principal-div">
    <h3 *ngIf="foPayService" class="title" style="padding-left:15px">Carrello pagamenti mese di competenza {{getMonths()}} {{foPayService.cartReq.year}}
        della denominazione azienda: {{foPayService.cartReq.subjectName}}</h3>
    <sigas-spinner *ngIf="pageLoadingInProgress"></sigas-spinner>
    <form *ngIf="!pageLoadingInProgress" #carrelloPagamenti="ngForm" (ngSubmit)="onSubmit()">

        
        <div style="padding-left: 5px; padding-right: 5px; margin-top: 20px">
            <div class="card card-primary">
            <sigas-alert [message]="message" *ngIf="showMsg" [type]="levelMessage"></sigas-alert>
                <div class="card-header text-white">
                    <strong>DATI GENERALI</strong>
                </div>
                <div>
                    <div class="card-body">
                        <div class="form-group row">
                            <div class="col-lg-12">
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <tbody>
                                                <tr>
                                                    <th>Denominazione azienda</th>
                                                    <td>{{foPayService.cartReq.subjectName}}</td>
                                                    <th>Codice Fiscale/P.Iva</th>
                                                    <td>{{foPayService.cartReq.codiceFiscalePIva}}</td>
                                                    <th>Stato</th>
                                                    <td>{{getStatus()}}</td>
                                                </tr>
                                                <tr>
                                                    <th>Mese di competenza </th>
                                                    <td>{{getMonths()}}</td>
                                                    <th colspan="2">Anno</th>
                                                    <td colspan="2">{{foPayService.cartReq.year}}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding-left: 5px; padding-right: 5px; margin-top: 20px">
            <div class="card card-primary">
                <div class="card-header text-white">
                    <strong>DETTAGLIO PAGAMENTO</strong>
                </div>
                <div>
                    <div class="card-body">
                        <div class="form-group row">
                            <div class="col-lg-12">
                                <div class="panel-body">

                                    <table class="table table-bordered table-striped" width="100%">
                                        <thead>
                                            <tr>
                                                <!--<th>Codice <b>Azienda</b></th>-->
                                                <th><b>Denominazione soggetto</b></th>
                                                <th><b>Provincia</b></th>
                                                <th><b>Mese</b></th>
                                                <th><b>Tipologia</b></th>
                                                <th><b>Importo</b></th>
                                                <th><b></b></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class ="pointer" *ngFor="let cartItem of foPayService.cartList | keyvalue">
                                                <!--<td>{{ cartItem.value.subjectCode }}</td>-->
                                                <td>{{ cartItem.value.subjectName }}</td>
                                                <td>{{ cartItem.value.area }}</td>
                                                <td>{{ cartItem.value.monthString() }}</td>
                                                <td>{{ cartItem.value.typeString() }}</td>
                                                <td>{{ getAmount(cartItem.value.amount) | currency:'EUR':'symbol'}}</td>
                                                <td>
                                                    <div class="btn-group" *ngIf="isDeletable()">
                                                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#dialogBox" (click)="dialogBoxShowDestroyCartItem(cartItem.value.id)"><i class="fa fa-times"></i> Cancella</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding-left: 5px; padding-right: 5px; margin-top: 20px">
            <div class="card card-primary">
                <div class="card-header text-white">
                    <strong>RIEPILOGO PAGAMENTO</strong>
                </div>
                <div>
                    <div class="card-body">
                        <div class="form-group row">
                            <div class="col-lg-12">
                                <div class="panel-body">
                                    <table class="table table-bordered table-striped">
                                        <tbody>
                                            <!-- <tr>
                                                <th>Acconto</th>
                                                <td>{{riepilogoPagamentoModel.carrello.acconti | currency:'EUR':'symbol'}}</td>
                                            </tr>-->
<!--
<tr>
    <th>Imposta</th>
    <td>{{getTotalAmount() | currency:'EUR':'symbol'}}</td>
</tr>
-->
                                            <!--
                                            <tr>
                                                <th>Sanzioni</th>
                                                <td>{{riepilogoPagamentoModel.carrello.sanzioni | currency:'EUR':'symbol'}}</td>
                                            </tr>
                                            <tr>
                                                <th>Interessi</th>
                                                <td>{{riepilogoPagamentoModel.carrello.interessi | currency:'EUR':'symbol'}}</td>
                                            </tr>
                                            -->
                                            <tr>
                                                <th>Totale</th>
                                                <td>{{getTotalAmount() | currency:'EUR':'symbol'}}</td>
                                            </tr>
                                            <!--
                                            <tr>
                                                <th>Acconto o Saldo</th>
                                                <td>{{foPayService.cartReq.month==13 ? 'Saldo' : 'Acconto'}}</td>
                                            </tr>
                                            -->
                                            <tr>
                                                <th>Codice di Pagamento</th>

                                                <td>{{foPayService.cartReq.paymentCode}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>



                        <sigas-alert *ngIf="flgCartSaved" [message]="'Bozza salvata correttamente nel carrello. Sarà possibile recuperare questo pagamento in qualunque momento dal menù \'Paga\''" [boldMessage]="causale" [type]="'SUCCESS'"></sigas-alert>
                        <sigas-alert *ngIf="paymentStartedOk" [message]="'Il pagamento è stato avviato con successo. Si prega di aspettare che il pagamento venga confermato per essere indirizzati alla pagina di pagamento PiemontePay.'" [boldMessage]="causale" [type]="'SUCCESS'"></sigas-alert>
                        <sigas-alert *ngIf="paymentStartError" [message]="'E\' avvenuto un errore nell\'avvio del pagamento. Si consiglia di provare in seguito.'" [boldMessage]="causale" [type]="'DANGER'"></sigas-alert>
                        <sigas-alert *ngIf="deleteAllCartOk" [message]="'Il carrelo è stato eliminato con successo.'" [boldMessage]="causale" [type]="'SUCCESS'"></sigas-alert>
                        <sigas-alert *ngIf="deleteAllCartError" [message]="deleteAllCartError" [boldMessage]="causale" [type]="'DANGER'"></sigas-alert>
    
                        <div class="form-group row">
                            <div class="col-lg-12">
                                <div class="panel-body">


                                    <div class="form-group" *ngIf="!paymentMethods || paymentMethods.length > 1">
                                        <label for="tipo_pagamento" class="col-sm-2 control-label">Tipo pagamento</label>
                                        <div class="col-sm-10">
                                            <select class="form-control " [(ngModel)]="foPayService.cartReq.paymentType" name="tipoPagamento" required>
                                                <option *ngFor="let type of paymentMethods" [ngValue]="type.idTipoPagamento">
                                                    {{type.descTipoPagamento}}
                                                </option>
                                                <!--
                                                <option *ngFor="let tipPag of tipoPagamentoModel" [value]="tipPag.id">{{tipPag.descrizione}}</option>
                                                -->
                                            </select>
                                        </div>
                                    </div>
                                    <!--
                                    <div class="form-group">
                                        <label for="dataDagamento" class="col-sm-2 control-label">Data pagamento</label>
                                        <div class="col-sm-10">
                                            {{foPayService.cartReq.currentDate}}
                                        </div>
                                    </div>
                                    -->
                    
                                    <!--<div class="form-group">
                                        <label for="versamento" class="col-sm-2 control-label">Data versamento</label>
                                        <div class="col-sm-10">
                                            <div class='input-group date' id='datetimepicker1'>
                                                <input #dataVers="ngbDatepicker"
                                                    (click)="dataVers.toggle()"
                                                    [(ngModel)]="foPayService.cartReq.payDate"
                                                    [footerTemplate]="footerTemplateDataVers"
                                                    class="form-control col-mg-8 col-lg-6 "
                                                    class="form-control"
                                                    name="dataVers"
                                                    id="dataVers"
                                                    ngbDatepicker
                                                    placeholder="gg/mm/aaaa"
                                                    readonly
                                                    required>


                                                <span class="input-group-addon">
                                                    <span class="glyphicon glyphicon-calendar"></span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                -->                    
                    
                    
                                    <div class="form-group">
                                        <label for="inputEmail" class="col-sm-2 control-label">Email per ricevuta</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="mail" placeholder="Email" maxlength="150" [(ngModel)]="foPayService.cartReq.email"
                                                name="email" class="form-control minuscolo" pattern="^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$"
                                                #email="ngModel" required>
                                            <div *ngIf="email.invalid && email.touched" class="alert alert-danger">
                                                <div *ngIf="email.errors.required ">
                                                    La Email è richiesta.
                                                </div>
                                                <div *ngIf="email.errors.pattern">
                                                    formato email: exemple@exemple.it
                                                </div>
                                                <div *ngIf="email.errors.mailDifferent">
                                                    mail non corrispondente
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                    
                                    <div class="form-group">
                                        <label for="inputEmail2" class="col-sm-2 control-label">Conferma email</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="confermaMail" placeholder="Conferma Email" maxlength="150" [(ngModel)]="confermaEmailModel" name="email1"
                                                class="form-control minuscolo" pattern="^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$" #email1="ngModel"
                                                required>
                                            <div *ngIf="(email1.invalid && email1.touched) || (!checkMails() && email1.touched)" class="alert alert-danger">
                                                <div *ngIf="email1.errors && email1.errors.required ">
                                                    La Email è richiesta.
                                                </div>
                                                <div *ngIf="email1.errors && email1.errors.pattern">
                                                    formato email: exemple@exemple.it
                                                </div>
                                                <div *ngIf="!checkMails()">
                                                    mail non corrispondente
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                    
                                    <!--pulsanti-->
                                    <div class="bs-example" data-example-id="single-button-dropdown">
                                        <div class="form-group row col-lg-12">
                                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 text-center">
                                                <div class="btn-group">
                                                    <a class="btn btn-default" (click)="goBack()" role="button">
                                                        <i class="fa fa-angle-left"></i>
                                                        indietro</a>
                                                </div>
                                                &nbsp;
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-primary" *ngIf="isDeletable()"
                                                            data-toggle="modal" data-target="#dialogBox" (click)="dialogBoxShowDestroyAllCart()">
                                                        <i class="fa fa-times"></i> Cancella</button>
                                                </div>
                                                &nbsp;
                                                <div class="btn-group">
                                                    <button type="button" [disabled]="!carrelloPagamenti.form.valid || !checkMails()" (click)="saveCart()" class="btn btn-primary">
                                                        <i class="fa fa-save"></i> Salva bozza</button>
                                                </div>
                                                &nbsp;
                                                <div class="btn-group">
                                                    <button type="button" [disabled]="!carrelloPagamenti.form.valid || !checkMails() || foPayService.cartReq.status=='40'" (click)="payCart()" class="btn btn-primary">
                                                        <i class="fa fa-check"></i> Conferma</button>
                                                </div>
                                                &nbsp;
                                                <div class="btn-group">
                                                    <button type="button" [disabled]="!carrelloPagamenti.form.valid" class="btn btn-success" (click)="downloadExcelCart()">
                                                        <i class="fa fa-file-excel"></i> Scarica in excel</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </form>
</div>


<div class="modal fade" id="dialogBox" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
				<h4 class="modal-title">{{dialogBoxTitle || 'Carrello'}}</h4>
				<button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>
                    <span>{{dialogBoxMessage}}</span>
                </p>
            </div>
            <div class="modal-footer">
               <button type="button" class="btn btn-primary" data-dismiss="modal" (click)="dialogBoxDismissButton()">Annulla</button>
               <button type="button" class="btn btn-default" data-dismiss="modal" (click)="dialogBoxConfirmButton()">S&igrave;</button>
            </div>
        </div>
    </div>
</div>