package it.csi.sigas.sigasbl.rest.api.impl;

import javax.servlet.http.HttpServletRequest;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.Response;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;
import org.springframework.stereotype.Service;

import it.csi.sigas.sigasbl.common.Constants;
import it.csi.sigas.sigasbl.common.Esito;
import it.csi.sigas.sigasbl.dispatcher.IUserDispatcher;
import it.csi.sigas.sigasbl.model.vo.ResponseVO;
import it.csi.sigas.sigasbl.model.vo.user.ProfilaturaVO;
import it.csi.sigas.sigasbl.rest.api.IUserApi;
import it.csi.sigas.sigasbl.security.UserDetails;
import it.csi.sigas.sigasbl.util.SpringSupportedResource;

@Service
public class UserApiImpl extends SpringSupportedResource implements IUserApi {

	@Autowired
	private IUserDispatcher userDispatcher;
	
    private final Logger logger = LoggerFactory.getLogger(this.getClass());
  

    public UserApiImpl() {
    }


    @Override
    public Response getProfilatura() {
    	logger.info("START: getProfilatura");
    	
		Authentication auth = SecurityContextHolder.getContext().getAuthentication();
		Object principal = auth.getPrincipal();
		UserDetails utente = (UserDetails) principal;

		ProfilaturaVO profilatura = userDispatcher.getProfilatura(utente);
		logger.info("END: getProfilatura");
		return Response.ok().entity(new ResponseVO<ProfilaturaVO>(Esito.SUCCESS, profilatura)).build();

	}
    
    @Override
	public Response localLogout(@Context HttpServletRequest req) {
		Authentication auth = SecurityContextHolder.getContext().getAuthentication();
		if (auth != null) {
			new SecurityContextLogoutHandler().logout(req, null, null);
		}

		return Response.ok(new ResponseVO<String>(Esito.SUCCESS, Constants.MESSAGE_SUCCESS)).build();
	}
}
